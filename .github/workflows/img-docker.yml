name: Tags & Build Front-End
 
on:
  push:
    branches:
      - main
 
permissions:
  contents: write
  packages: write
 
jobs:
  tags:
    runs-on: ubuntu-latest
    outputs:
      git_tag: ${{ steps.newtag.outputs.git_tag }}
      docker_tag: ${{ steps.newtag.outputs.docker_tag }}
 
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
 
      - name: Fetch tags
        run: git fetch --tags
 
      - name: Determine new version
        id: newtag
        run: |
          LAST_TAG=$(git tag --sort=-v:refname | head -n 1)
 
          if [ -z "$LAST_TAG" ]; then
            MAJOR=0
            MINOR=0
            PATCH=1
          else
            VERSION=${LAST_TAG#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
 
            PATCH=$((PATCH + 1))
 
            if [ "$PATCH" -gt 9 ]; then
              PATCH=0
              MINOR=$((MINOR + 1))
            fi
 
            if [ "$MINOR" -gt 9 ]; then
              MINOR=0
              MAJOR=$((MAJOR + 1))
            fi
          fi
 
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
 
          echo "New version: $NEW_VERSION"
          echo "git_tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "docker_tag=$NEW_VERSION" >> $GITHUB_OUTPUT
 
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
 
      - name: Create and push Git tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git tag ${{ steps.newtag.outputs.git_tag }}
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git ${{ steps.newtag.outputs.git_tag }}
 
  build-and-push:
    needs: tags
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
 
      - name: Convert repo name to lowercase
        id: repo_name
        run: |
          echo "lower=$(echo '${{ github.repository }}' | cut -d'/' -f2 | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
 
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
 
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
 
      - name: Build and push Docker images
        uses: docker/build-push-action@v3
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ steps.repo_name.outputs.lower }}:${{ needs.tags.outputs.docker_tag }}
            ${{ secrets.DOCKER_USERNAME }}/${{ steps.repo_name.outputs.lower }}:latest
            ghcr.io/psy2bib/${{ steps.repo_name.outputs.lower }}:${{ needs.tags.outputs.docker_tag }}
            ghcr.io/psy2bib/${{ steps.repo_name.outputs.lower }}:latest
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.version=${{ needs.tags.outputs.docker_tag }}
